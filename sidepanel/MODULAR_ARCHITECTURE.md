# Модульная архитектура 8pilot Sidepanel

## Обзор

Sidepanel был декомпозирован на модули для улучшения поддерживаемости, читаемости и расширяемости кода. Каждый модуль отвечает за определенную функциональность и может быть независимо тестирован и модифицирован.

## Структура модулей

```
sidepanel/
├── modules/
│   ├── auth.js          # Аутентификация и управление пользователями
│   ├── theme.js         # Управление темами (светлая/темная/авто)
│   ├── chat.js          # Управление чатом и AI взаимодействием
│   ├── n8n.js           # Интеграция с n8n
│   ├── settings.js      # Управление настройками приложения
│   ├── workflow.js      # Управление workflow и страницами
│   ├── templates.js     # Управление шаблонами workflow
│   └── main.js          # Основная логика инициализации
├── sidepanel-modular.html  # HTML для модульной версии
└── sidepanel.css        # Стили (общие для обеих версий)
```

## Описание модулей

### 1. AuthManager (`auth.js`)
**Ответственность:** Аутентификация, регистрация, управление сессиями
- Вход/выход пользователей
- Регистрация новых аккаунтов
- Демо режим
- Управление токенами
- Многоязычность (EN/RU)

**Основные методы:**
- `init()` - инициализация
- `handleLogin()` - обработка входа
- `handleSignup()` - обработка регистрации
- `activateDemoMode()` - активация демо режима
- `logout()` - выход из системы

### 2. ThemeManager (`theme.js`)
**Ответственность:** Управление темами интерфейса
- Автоматическое определение системной темы
- Переключение между светлой/темной/авто темами
- Сохранение предпочтений пользователя
- Уведомления об изменении темы

**Основные методы:**
- `setTheme(theme)` - установка темы
- `getEffectiveTheme()` - получение активной темы
- `cycleTheme()` - циклическое переключение тем

### 3. ChatManager (`chat.js`)
**Ответственность:** Управление чатом и AI взаимодействием
- Отправка/получение сообщений
- Потоковая обработка ответов AI
- Управление историей чата
- Интеграция с workflow
- Применение workflow к n8n

**Основные методы:**
- `sendMessage()` - отправка сообщения
- `callAI()` - вызов AI API
- `applyWorkflow()` - применение workflow
- `loadWorkflowChat()` - загрузка чата для workflow

### 4. N8nManager (`n8n.js`)
**Ответственность:** Интеграция с n8n
- Автоматическое обнаружение n8n инстансов
- Настройка API подключения
- Тестирование соединения
- Управление состоянием подключения

**Основные методы:**
- `initN8nConnection()` - инициализация подключения
- `testN8nConnection()` - тестирование соединения
- `showN8nSetupModal()` - показ модала настройки

### 5. SettingsManager (`settings.js`)
**Ответственность:** Управление настройками приложения
- Сохранение/загрузка настроек
- Переключение между AI провайдерами
- Управление настройками чата
- Интерфейс настроек

**Основные методы:**
- `loadSettings()` - загрузка настроек
- `saveSettings()` - сохранение настроек
- `switchProvider()` - переключение провайдера

### 6. WorkflowManager (`workflow.js`)
**Ответственность:** Управление workflow и страницами
- Определение текущего workflow
- Обновление информации о workflow
- Статус подключения к n8n
- Управление UI workflow

**Основные методы:**
- `getCurrentTabInfo()` - получение информации о текущей вкладке
- `updateWorkflowInfo()` - обновление информации о workflow
- `loadWorkflowStats()` - загрузка статистики workflow

### 7. TemplatesManager (`templates.js`)
**Ответственность:** Управление шаблонами workflow
- Предустановленные шаблоны
- Фильтрация по категориям
- Использование шаблонов в чате
- Экспорт/импорт шаблонов

**Основные методы:**
- `renderTemplates()` - отрисовка шаблонов
- `useTemplate()` - использование шаблона
- `filterTemplates()` - фильтрация по категории

### 8. SidepanelApp (`main.js`)
**Ответственность:** Основная логика приложения
- Инициализация всех модулей
- Координация между модулями
- Глобальные обработчики событий
- Управление жизненным циклом приложения

**Основные методы:**
- `init()` - инициализация приложения
- `initializeModules()` - инициализация модулей
- `start()` - запуск приложения

## Преимущества модульной архитектуры

### 1. Разделение ответственности
Каждый модуль отвечает за конкретную функциональность, что упрощает понимание и поддержку кода.

### 2. Переиспользование
Модули могут быть легко переиспользованы в других частях приложения или в других проектах.

### 3. Тестируемость
Каждый модуль может быть протестирован независимо, что упрощает отладку и разработку.

### 4. Расширяемость
Новые функции можно добавлять, создавая новые модули или расширяя существующие.

### 5. Поддерживаемость
Код легче читать, понимать и модифицировать.

## Использование

### Загрузка модулей
Модули загружаются в правильном порядке в HTML:

```html
<script src="modules/auth.js"></script>
<script src="modules/theme.js"></script>
<script src="modules/chat.js"></script>
<script src="modules/n8n.js"></script>
<script src="modules/settings.js"></script>
<script src="modules/workflow.js"></script>
<script src="modules/templates.js"></script>
<script src="modules/main.js"></script>
```

### Инициализация
Приложение автоматически инициализируется при загрузке DOM:

```javascript
// Автоматически создается при загрузке
window.sidepanelApp = new SidepanelApp();
```

### Доступ к модулям
Модули доступны через глобальные переменные:

```javascript
// Доступ к менеджеру аутентификации
window.authManager.login();

// Доступ к менеджеру чата
window.chatManager.sendMessage('Hello');

// Доступ к менеджеру тем
window.themeManager.setTheme('dark');
```

## Миграция с монолитной версии

### 1. Обновить HTML
Заменить `sidepanel.html` на `sidepanel-modular.html`

### 2. Обновить ссылки на функции
Функции теперь доступны через соответствующие модули:

```javascript
// Старый способ
getCurrentTabInfo();

// Новый способ
window.workflowManager.getCurrentTabInfo();
```

### 3. Обновить обработчики событий
Обработчики событий теперь управляются соответствующими модулями.

## Добавление новых модулей

### 1. Создать файл модуля
```javascript
// modules/new-feature.js
class NewFeatureManager {
  constructor() {
    this.init();
  }
  
  init() {
    // Инициализация
  }
}

window.NewFeatureManager = NewFeatureManager;
```

### 2. Добавить в HTML
```html
<script src="modules/new-feature.js"></script>
```

### 3. Инициализировать в main.js
```javascript
// В методе initializeModules()
this.modules.newFeature = new window.NewFeatureManager();
window.newFeatureManager = this.modules.newFeature;
```

## Лучшие практики

### 1. Единая ответственность
Каждый модуль должен отвечать только за одну область функциональности.

### 2. Минимальные зависимости
Модули должны иметь минимальные зависимости друг от друга.

### 3. Публичный API
Каждый модуль должен предоставлять четкий публичный API.

### 4. Обработка ошибок
Модули должны корректно обрабатывать ошибки и не ломать приложение.

### 5. Документация
Каждый модуль должен быть документирован с описанием его назначения и API.

## Заключение

Модульная архитектура значительно улучшает качество кода и упрощает разработку. Каждый модуль имеет четкую ответственность и может быть независимо разработан, протестирован и поддерживаем.
